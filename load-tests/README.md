# Load Testing Scripts (load-tests)

## 1. 개요
- **부하 테스트 스크립트 모음**: 이 디렉터리는 `blog-service`의 API에 다양한 유형의 부하를 발생시켜 시스템의 성능과 안정성을 측정하기 위한 셸 스크립트(`- .sh`)들을 포함하고 있음
- **순수 셸 및 curl 기반**: 별도의 부하 테스트 도구 설치 없이, `sh`와 `curl` 명령어만으로 실행할 수 있도록 작성되어 사용 편의성이 높음 (`jq`가 설치되어 있으면 결과 확인이 더 용이함)
- **다양한 시나리오 제공**: 단순 조회 위주의 테스트(`mixed_load.sh`)부터, 생성/수정/삭제를 포함하는 복합적인 시나리오(`mixed_load_plus.sh`) 및 특정 API의 기능 진단을 위한 스크립트(`diag_delete.sh`)까지 제공하여 다각적인 테스트를 지원함

## 2. 핵심 기능 및 책임
- **성능 측정**: 지정된 시간 동안 특정 비율로 API를 호출하여 시스템이 목표 처리량(RPS)을 안정적으로 감당할 수 있는지 확인함
- **안정성 검증**: 부하 발생 시 `load-balancer`의 `/stats` 엔드포인트를 모니터링하여, 평균 응답 시간, 실패율(`success_rate`) 등이 허용 범위 내에서 유지되는지 검증
- **기능 진단**: 특정 API(예: `DELETE /api/posts/{id}`)가 CRUD 흐름에 따라 정상적으로 동작하는지, 생성-조회-삭제-확인 단계를 거쳐 진단함
- **테스트 데이터 자동 생성 및 정리**: 테스트 실행에 필요한 사용자 계정과 게시물을 자동으로 생성하며, 테스트 종료 후 생성된 데이터를 정리하는 옵션을 제공하여 반복적인 테스트를 용이하게 함

## 3. 기술적 구현 (Shell Script)
- 모든 스크립트는 `curl`을 백그라운드 작업(`&`)으로 동시에 실행하고, 매초 `wait` 명령어로 동기화하는 방식을 사용하여 지정된 RPS(Requests Per Second)와 유사한 부하를 생성함

### 3.1. `mixed_load.sh` (기본 읽기 위주 부하)
- **시나리오**:
    1.  **사전 준비**: 테스트 전용 임시 사용자(`ml_...`)를 등록하고 로그인하여 JWT 토큰을 발급받음
    2.  테스트에 사용할 시드(seed) 게시물을 여러 개 생성
    3.  **동시 실행**: 지정된 `duration` 동안, 사용자가 설정한 비율(`--rate-list`, `--rate-detail`, `--rate-create`)에 맞춰 아래 세 가지 요청을 병렬로 실행
        - `GET /api/posts` (목록 조회)
        - `GET /api/posts/{id}` (상세 조회, 시드 게시물 중 랜덤 선택)
        - `POST /api/posts` (새 게시물 생성)
- **목적**: 읽기 작업이 대부분인 일반적인 웹 서비스 환경을 시뮬레이션하여, 조회 성능과 소량의 쓰기 작업이 미치는 영향을 테스트

### 3.2. `mixed_load_plus.sh` (복합 읽기/쓰기 부하)
- **시나리오**: `mixed_load.sh`의 모든 기능을 포함하며, **수정** 및 **삭제** 요청을 추가하여 더 복잡한 부하를 생성
    - `PATCH /api/posts/{id}` (게시물 수정)
    - `DELETE /api/posts/{id}` (게시물 삭제)
- **자동 정리 기능**:
    - `--cleanup` 플래그를 사용하여 테스트 종료 후, 이번 테스트 실행 중에 생성되었던 게시물들을 자동으로 삭제할 수 있음
    - 삭제는 **이번 실행에서 생성된 게시물 ID**를 우선적으로 시도하고, 여의치 않을 경우 제목 접두사(`mlp-`)를 기준으로 2차 시도를 함

### 3.3. `diag_delete.sh` (삭제 기능 진단)
- **시나리오**:
    1.  사용자 등록 및 로그인 후 토큰 획득
    2.  테스트용 게시물 **1개** 생성 후 `POST_ID` 저장
    3.  **삭제 전**: `GET /api/posts/{POST_ID}`를 호출하여 상태 코드가 `200 OK`인지 확인
    4.  **삭제 실행**: `DELETE /api/posts/{POST_ID}`를 호출하여 상태 코드가 `204 No Content`인지 확인
    5.  **삭제 후**: 다시 `GET /api/posts/{POST_ID}`를 호출하여 상태 코드가 `404 Not Found`로 변경되었는지 최종 확인
- **목적**: `DELETE` API와 관련된 전체적인 인증, 권한, 데이터 처리 흐름이 정상적으로 동작하는지 독립적으로 검증

## 4. 실행 방법
- **기본 부하 테스트**:
    ```sh
    sh ./mixed_load.sh --url <LB 주소> --duration 60s --rate-list 64 --rate-detail 12 --rate-create 4
    ```
- **복합 부하 테스트**:
    ```sh
    sh ./mixed_load_plus.sh --url <LB 주소> --duration 60s --rate-list 40 --rate-detail 15 --rate-create 8 --rate-update 4 --rate-delete 3
    ```
- **생성된 데이터 정리만 실행**:
    ```sh
    sh ./mixed_load_plus.sh --url <LB 주소> --cleanup
    ```
- **삭제 기능 진단**:
    ```sh
    sh ./diag_delete.sh --url <LB 주소>
    ```

## 5. 설정 (스크립트 인자)
- `--url`: 부하를 가할 대상인 로드밸런서의 기본 주소 (필수)
- `--duration`: 부하 테스트를 지속할 시간 (예: `60s`, `2m`)
- `--rate-*`: 각 API 종류별로 초당 보낼 요청 수 (RPS)
- `--cleanup`: (`mixed_load_plus.sh` 전용) 테스트 종료 후 생성된 데이터를 정리