apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

# Namespace for all resources
namespace: titanium-prod

# Name prefix for all resources
namePrefix: prod-

# Base resources
resources:
  - ../../base
  - namespace.yaml
  - postgresql-statefulset.yaml

# Patches for GCP environment
patches:
  # Remove SQLite PVC from user-service deployment
  - path: patches/user-service-deployment-patch.yaml
    target:
      kind: Deployment
      name: user-service-deployment

  # Update blog-service deployment for PostgreSQL
  - path: patches/blog-service-deployment-patch.yaml
    target:
      kind: Deployment
      name: blog-service-deployment

  # Inject secrets into auth-service
  - path: patches/auth-service-deployment-patch.yaml
    target:
      kind: Deployment
      name: auth-service-deployment

  # LoadBalancer service type for GCP (NodePort for external access)
  - path: patches/service-lb-patch.yaml
    target:
      kind: Service
      name: api-gateway-service

# ConfigMap generator for production-specific config
configMapGenerator:
  - name: app-config
    behavior: merge
    literals:
      - USE_POSTGRES=true
      - POSTGRES_HOST=postgresql-service
      - POSTGRES_PORT=5432
      - POSTGRES_DB=titanium
      - API_GATEWAY_URL=http://prod-api-gateway-service:8000
      - USER_SERVICE_URL=http://prod-user-service:8001
      - AUTH_SERVICE_URL=http://prod-auth-service:8002
      - BLOG_SERVICE_URL=http://prod-blog-service:8005
      - REDIS_HOST=prod-redis-service
      - REDIS_PORT=6379
      - REDIS_DB=0
      - ENVIRONMENT=production
      - LOG_LEVEL=INFO
      - DEBUG_MODE=false
      - APP_NAME=titanium
      - APP_VERSION=2.0.0
      - ALLOWED_ORIGINS=*

# Secret management
# SECURITY: Secrets are managed via Terraform bootstrap script
# PostgreSQL secret is created in titanium-prod namespace during k3s-server.sh bootstrap

# Common labels for all resources
labels:
  - pairs:
      environment: production
      platform: gcp
      managed-by: argocd
      project: titanium

# Images to use (Docker Hub registry)
images:
  - name: dongju101/user-service
    newTag: main-9820acf
  - name: dongju101/blog-service
    newTag: main-bf0a510
  - name: dongju101/auth-service
    newTag: main-12744b6
  - name: dongju101/api-gateway
    newTag: main-3b3150e

# Resource modifications (reduced for single-worker GCP deployment)
replicas:
  - name: user-service-deployment
    count: 1
  - name: blog-service-deployment
    count: 1
  - name: auth-service-deployment
    count: 1
  - name: api-gateway-deployment
    count: 1
